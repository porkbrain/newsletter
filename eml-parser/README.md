# `dedup`
Parses email to text and matches it against similar emails received before. See the [inbound pipeline description](../README.md) to understand how `dedup` fits in with other services.

Before is limited to last `N` days. We don't want `N` too large because it increases the number of emails to check against and merchants might reuse the same templates to send different vouchers between seasons. The deduplication is _not implemented_ yet ([#1]).

`dedup` listens to SQS [`new_email`](../../deployment/README.md#new_email) to capture messages of newly stored S3 objects. It fetches the object and uses [mailparser][mailparser] to extract body from the MIME file. The body is then parsed by [htmlparser2][htmlparser2]. If everything is as expected we store the email information in a database and send a message to SQS [`analyse_text.fifo`](../../deployment/README.md#analyse_text.fifo).

## S3 email key vs email id
We store the S3 bucket object name in db use postgres _int_ id to reference to the email across services. The S3 object name is a random string generated by the SES when storing the email as a file or hash of the email (for example: `7gfmhp045dv9hfst94stsrfr8mieseafn6b0ce01`).

## Resources
`dedup` needs access for reading and deleting SQS `new_email` messages, sending `analyse_text.fifo` messages. It needs to read objects from `mailmevouchers` S3 bucket. It needs access to a postgres db.

## Output
Pushes into [`analyse_text.fifo`](../../deployment/README.md#analyse_text.fifo) following JSON:

```json
{
    "text": "Text extracted from html",
    "emailId": "emailId",
    "isFromOcr": false
}
```

## Test
```bash
npm t

npm run integration-tests
```

<!-- References -->
[#1]: https://github.com/bausano/mailmevouchers.com/issues/1
[htmlparser2]: https://www.npmjs.com/package/htmlparser2
[mailparser]: https://www.npmjs.com/package/mailparser
[s3-to-sqs]: https://docs.aws.amazon.com/AmazonS3/latest/dev/ways-to-add-notification-config-to-bucket.html
